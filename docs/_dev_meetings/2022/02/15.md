---
title: February 15, 2021
tags: [Deployment Checklist]
date: 2022-02-15
excerpt: "Minutes from the February 15, 2021 GPA Lab developer's meeting. In which we write a deployment checklist."
---

## Deployment Checklist

**Update Window:** Friday February 15, 2022

**Personnel:** Terri, Michael, Edwin, Temi, Marek

**Content Freeze:** Three hours (4:00 PM - 7:00 PM)

**Order of Operation:**

1. Update changelog for API, client, and server
1. Tag the releases
   - API: minor => v6.1.0
   - Client: minor => v5.13.0
   - Server: minor => v5.11.0
1. Take snapshots for backup (Prisma DB and Elasticsearch)
1. Run the Jenkins jobs:
   - Execute API build
   - Execute server build
   - Execute prisma deploy build
   - Execute prisma seed build
   - Execute client
1. Seed the API taxonomy
   - [Generate prod bearer token](#generate-token)
   - Map api.america.gov to appropriate IPs
   - Use Postman to send `cdp_language.csv` to the bulk upload endpoint (add Bangla)
   - Use Postman to send `cdp_owner.csv` to the bulk upload endpoint (add R&A teams)
   - Use Postman to send `cdp_taxonomy.csv` to the bulk upload endpoint (new taxonomy)
1. Run GraphQL Operations
   1. Open the Prisma management playground
   1. Generate Prisma authorization token (via Jenkins)
   1. Run operations
   - [Delete redundant re-named regions](#gql-regions)
   - [Add R&A Team editors via GraphQL](#gql-update-users)
   - [Give R&A teams access to document content type](#gql-content-type)
   1. Close the Prisma playground

<details id="generate-token" open>
  <summary><strong>Generate GraphQL Bearer Token</strong></summary>
  <ol>
    <li>Download the Commons server repo (<code>git clone git@github.com:IIP-Design/content-commons-server.git</code>)</li>
    <li>Navigate into the repo directory <code>cd content-commons-server</code></li>
    <li>At the root of this directory, create file called <code>.env</code></li>
    <li>Within this file, add entries for the following variables and populate them with the appropriate values:
      <ul>
        <li><code>ES_APP_USER</code></li>
        <li><code>ES_APP_SECRET</code></li>
      </ul>
    </li>
    <li>Install the needed dependencies by running <code>npm install</code></li>
    <li>Generate the token by running <code>npm run token</code>. This will print the generated token to your terminal.</li>
  </ol>
</details>

<details id="gql-regions" open>
  <summary><strong>GraphQL Delete Redundant Regions Operation</strong></summary>
  <pre><code class="language-graphql hljs">
# Get region ids
query GET_REGION {
  regions {
    id
    name
  }
}
# Delete the old bureau prefixed regions
mutation DELETE_REDUNDANT_REGIONS {
  deleteManyRegions(
    where: {
      id_in: [
        "ck9ips7u600gj0997c30j4fbt", # Bureau of African Affairs
        "ck9ips7zn00id09975i0jgzc6", # Bureau of East Asian and Pacific Affairs
        "ck9ips7zo00ig0997mebi37tr", # Bureau of European and Eurasian Affairs
        "ck9ips7zm00ic0997ah6r8vac", # Bureau of Near Eastern Affairs
        "ck9ips7u800gq0997s8rhwm74", # Bureau of South and Central Asian Affairs
        "ck9ips82400nq0997xlekasum", # Bureau of Western Hemisphere Affairs
        "" # Bureau of International Organization Affairs
      ]
    }
  ) {
    __typename
  }
}
  </code></pre>
</details>

<details id="gql-update-users" open>
  <summary><strong>GraphQL Add/Update R&A Users</strong></summary>
  <pre><code class="language-graphql hljs">
# Get the team ids.
query GET_TEAMS {
  teams {
    id
    name
  }
}
# Create/Update the user.
mutation UPSERT_USER {
  upsertUser (
    where: {
      email: "user@email"
    }
    # Create the User if they don't exist yet
    create: {
      email: "user@email"
      firstName: "First"
      lastName: "Last"
      permissions: {
        set: [EDITOR]
      }
      team: {
        connect: {
          id: "team id"
        }
      }
    }
    # Update the User if they've already been added
    update: {
      email: "user@email"
      firstName: "First"
      lastName: "Last"
      permissions: {
        set: [EDITOR]
      }
      team: {
        connect: {
          id: "team id"
        }
      }
    }
  ) {
    email
    permissions
    team {
      name
    }
  }
}
  </code></pre>
</details>

<details id="gql-content-type" open>
  <summary><strong>GraphQL Set Content Type Operation</strong></summary>
  <pre><code class="language-graphql hljs">
# Get the team ids.
query GET_TEAMS {
  teams {
    id
    name
  }
}
# Give a team access to documents.
mutation UPDATE_TEAM {
  updateTeam(
    where: {
      id: "team-id"
    }
    data: {
      contentTypes: {
        set: [DOCUMENT]
      }
    }
  ) {
    name
    contentTypes
  }
}
  </code></pre>
</details>

## Talking Points

test the the network connections

Michael is adding IP addresses network ACL whitelist

- AppSheets
- CloudFlare

Marek connect the dev database from CPMO AWS to the dev app in AppSheet

- Add database
- Change application data source
- Switch table data source (for quotes and talking_points)

Switch the production domain (talkingpoints.america.gov) over the the CPMO AWS

1. via Cloudflare
   - Verify that added Okta authentication splash screen doesn't need additional rules (ie. caching)
   - Disable Cloudflare Access
2. In Cognito

Sync the CPMO AWS database to the current production (GPA Lab AWS) database

Michael wants to automate DB backups to S3 on a daily cron (to supplement built in RDS 35 day backups) and send RDS logs to CloudWatch. Blocked by lack of permissions in CPMO AWS.

Confirm and schedule transition with Talking Points team (Shawn & Ashley) - tentatively Wednesday next week
