<p align="center">
  <img src="./docs/assets/eye.png" width="200">
</p>

## Lab Multi-Proxy

The Lab Multi-proxy is a Caddy web server that can be used to reverse proxy multiple GPA Digital Lab projects at once. It allows simultaneous testing and development on multiple properties and helps to avoid port clashes caused by running multiple web-servers on localhost.

> One Proxy to rule them all, One Proxy to find them,\
> One Proxy to bring them all, and in the Dockers bind them,
>
> ~ J.R.R Tolkien...kinda

### Available Projects

Specifically, the proxy maps the following resources to local URLs.

**Content Commons:**

- _[Content Commons Client](https://github.com/IIP-Design/content-commons-client):_ localhost:3000 -> [commons.dev.local](https://commons.dev.local)
- _[Content Commons Server](https://github.com/IIP-Design/content-commons-server):_ localhost:4000 -> [commons-server.dev.local](https://commons-server.dev.local)
- _[CDP Public API](https://github.com/IIP-Design/cdp-public-api):_ localhost:8080 -> [api.dev.local](https://api.dev.local)
- _[Content Dev WP Site:](https://github.com/IIP-Design/Content)_ content_web Docker container -> [content.dev.local](https://content.dev.local)
- _Content Dev WP Site Adminer:_ content_adminer Docker container -> [content.adminer.local](https://commons.adminer.local)

**Lab WordPress Site:**

- _[Lab Dev WP Site](https://github.com/IIP-Design/lab-headless):_ lab_web Docker container -> [lab.dev.local](https://lab.dev.local)
- _Lab Dev WP Site Adminer:_ lab_adminer Docker container -> [lab.adminer.local](https://lab.adminer.local)

### SSL Certificates

By default, Caddy provisions each of the mapped local domains with a self-signed SSL/TLS certificate. This allows the various components to communicate over `https` rather than `http`, providing a more realistic environment.

By their very nature, self-signed certificates are less secure than certificates signed by a verified Certificate Authority and should not be used in production. As a result, when visiting one of the development domains above, your browser may notify you that site's certificate is not valid.

You can safely ignore the warnings and proceed to the site. However, after a time these warnings may become rather annoying. To entirely remove the warnings:

1. Open your computer's keychain (on Macs found at `Applications > Utilities > Keychain Access`).
1. Locate the root and intermediate certificates generated by Caddy (found in this repo at `config/caddy-data/caddy/pki/authorities/local/root.crt` and `config/caddy-data/caddy/pki/authorities/local/intermediate.crt`, respectively).
1. Drag the two certificate files into your keychain.
1. Double click on each of the certificate files and in the `Trust` section of the resulting modal, set the `When using this certificate` dropdown to `Always Trust`.

The provisioned certificates should now work on Chrome, however, further browser configuration may be need to ensure the certs are trusted by some other browsers (ex: [Firefox](https://javorszky.co.uk/2019/11/06/get-firefox-to-trust-your-self-signed-certificates/)).

**Note:** Be careful when adding certificates to your keychain. You should only trust certificates when you are certain of their origin.

### Docker Networks

In order to connect directly to other Docker containers, the proxy server needs to join those containers' internal networks. You do not need to be actively running all of these development containers to start the proxy, but their respective networks must exist on your system.

Specifically, the proxy server looks for the following external networks:

- `content_net`
- `lab_net`

If you are missing any of the listed networks, the `docker-compose up` command will fail to run and the proxy server will not start. To address this issue, either start the missing application to create the requisite network or comment out the missing network(s) in the `x-networks` portion of the `docker-compose.yml` file.

**Note:** To see what networks you have running on your system simply run the following command: `docker network ls`.

If at a future point you add one of the missing networks, simply uncomment it in the `docker-compose.yml` file and restart the container.

### Content Commons Environmental Variables

In order to take full advantage to the domain mapping provided by this proxy, you should makes sure that all appropriate environmental variables in your Commons dev environments are set correctly. Failure to do so may cause a domain mismatch leading to [CORS errors](https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS/Errors) and lack of interconnection between the various micro-service. Specifically, you will want to set the following values in each repository's `.env` file:

- Content Commons Client:
  - `REACT_APP_PUBLIC_API=https://api.dev.local`
  - `REACT_APP_APOLLO_ENDPOINT=https://commons-server.dev.local/graphql`
  - `REACT_APP_AWS_COGNITO_CLIENT_REDIRECT_SIGNIN=https://commons.dev.local/login/`
  - `REACT_APP_AWS_COGNITO_CLIENT_REDIRECT_SIGNOUT=https://commons.dev.local/`
- Content Commons Server:
  - `FRONTEND_URL=https://commons.dev.local`
